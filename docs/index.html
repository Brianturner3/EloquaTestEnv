<!DOCTYPE html>
<!-- Simple example of page using data lookups to retrieve visitor data info-->
<!--[if lte IE 6]><html class="preIE7 preIE8 preIE9"><![endif]-->
<!--[if IE 7]><html class="preIE8 preIE9"><![endif]-->
<!--[if IE 8]><html class="preIE9"><![endif]-->
<!--[if gte IE 9]><!--><html><!--<![endif]-->
  <head>
    <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Eloqua Datalookup Test</title>
  <meta name="author" content="name">
  
  <!-- PART 1 : VARIABLES -->
  <script type="text/javascript">
    // Make Changes
    let EloquaSiteId = '2126376800';
    let primaryUniqueField = 'C_EmailAddress';
    const getEmailFromURL = (key) => {
      let urlParams = new URLSearchParams(window.location.search);
      return decodeURIComponent(urlParams.get(key));
    }
    let emailAddress = getEmailFromURL('email');
    let contactLookupKey = 'df645c355f214bda9085fc51b9369e0c';
    let emailGroupLookupKey = '49570d20c1c64fd19d849155906e4c41';
    let visitoryLookupKey = '413a9d53f2f3459b8f03aad685648a16';
    let EloquaFormID = 'ElqSubCenter';
    // End Changes
  </script>

  <!-- PART 2 : STD ELOQUA ASYNCHRONOUS TRACKING CODE -->
  <script type="text/javascript">
      var _elqQ = _elqQ || [];
      _elqQ.push(['elqSetSiteId', EloquaSiteId]);
      _elqQ.push(['elqTrackPageView']);

      (function () {
          function async_load() {
              var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true;
              s.src = '//img.en25.com/i/elqCfg.min.js'; //Path to elqCfg.min.js
              var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x);
          }
          if (window.attachEvent) { window.attachEvent('onload', async_load); }
          else { window.addEventListener('DOMContentLoaded', async_load, false); }
      })();
  </script>

  </head>
  <body>
  <!-- Title -->
  <h1>Test Page: Data Lookups</h1>
  
  <!-- Form -->
    <form action="https://s2126376800.t.eloqua.com/e/f2" method="post" name="BasicForm" id="ElqSubCenter">
      <input type="hidden" name="elqCustomerGUID" value="">
      <input type="hidden" name="elqCookieWrite" value="0">
      <input type="hidden" name="elqFormName" value="BasicForm">
      <input type="hidden" name="elqSiteID" value="2126376800">
      <h5>Contact Information:</h5><br>
      First name:<input type="text" name="firstname"><br>
      Last name:<input type="text" name="lastname"><br>
      Email:<input type="email" name="email"><br>
      State: <input type="text" name="state"><br>
      Zipcode: <input type="text" name="zipcode"><br><br>
      <h5>Email Preferences:</h5><br>
      Marketing Emails: <input type="checkbox" name="marketingPref" id="marketingPref"><br>
      Sales Emails: <input type="checkbox" name="salesPref" id="salesPref"><br>
      <input type="submit" value="Submit">
    </form>

    <!-- PART 3 : UPDATE FORM -->
    <script type="text/javascript">

      // Update DOM with contact information from data lookup
      function loadContactCategories(){
        console.log('Enter Contact Categories');
        console.log('First Name: '+ GetElqContentPersonalizationValue('C_FirstName'));
        console.log('Last Name: '+ GetElqContentPersonalizationValue('C_LastName'));
        console.log('Email: '+ GetElqContentPersonalizationValue('C_EmailAddress'));
        console.log('Province: '+ GetElqContentPersonalizationValue('C_State_Prov'));
        console.log('Zipcode: '+ GetElqContentPersonalizationValue('C_Zip_Postal'));
      }

      // Update DOM with visitor information from data lookup
      function loadVisitorCategories(){
        console.log('Enter Visitor Categories');
        console.log('First Name: '+ GetElqContentPersonalizationValue('V_ElqFirstName'));
        console.log('Last Name: '+ GetElqContentPersonalizationValue('V_ElqLastName'));
        console.log('Email: '+ GetElqContentPersonalizationValue('V_ElqEmailAddress'));
        console.log('Province: '+ GetElqContentPersonalizationValue('V_ProvinceFromIP'));
        console.log('Zipcode: '+ GetElqContentPersonalizationValue('V_ZipCodeFromIP'));
      }

      function loadSubscriptions(){
        console.log('Enter Subscription');
        // Make Changes: Email Group and 'Subscription DataLookup Id'
        var marketingGUID = '{853dfa57-87ef-4fdb-a6d9-38152b032ac9}';
        var salesGUID = '{e1250a1e-2ee1-4c3b-963d-c7df6b047176}';
        // End Changes

        console.log('Group Membership ' + GetElqGroupMembershipStatus(marketingGUID));
        console.log('Group Membership ' + GetElqGroupMembershipStatus(salesGUID));
        // Set Subscription Checkboxes. Make changes here depending on the ID of the checkboxes
        (GetElqGroupMembershipStatus(marketingGUID)) ? document.getElementById('marketingPref').checked = true : document.getElementById('marketingPref').checked = false;
        (GetElqGroupMembershipStatus(salesGUID)) ? document.getElementById('salesPref').checked = true : document.getElementById('salesPref').checked = false;
      }
    </script>

  <!-- PART 4 : ELOQUA WEB DATA LOOKUPS -->
  <script type="text/javascript">
    let firstLookup = true;
    let secondLookup = false;
    let getSubscriptionInfo = false;

    // Call back function automatically called after data lookup
    function SetElqContent(){
      console.log('Enter SetElqContent');
      if(firstLookup){
        // If function is available assume that datalookup was successful
        if(this.GetElqContentPersonalizationValue){
          // Call Email Group Data Lookup
          firstLookup = false;
          secondLookup = true;
          getSubscriptionInfo = true;
          _elqQ.push(['elqDataLookup', escape(emailGroupLookupKey),'<'+primaryUniqueField+'>'+emailAddress+'</'+primaryUniqueField+'>']);  
        }
        else{
          // Call Visitor Data Lookup
          firstLookup = false;
          secondLookup = true;
          _elqQ.push(['elqDataLookup', escape(visitoryLookupKey),'']);
        }
      }
      else if(!firstLookup && secondLookup && !getSubscriptionInfo){
        console.log('Enter Second Lookup');
        // If function is available assume that datalookup was successful
        if(this.GetElqContentPersonalizationValue){
          getSubscriptionInfo = true;
          console.log(GetElqContentPersonalizationValue('V_ElqEmailAddress'));
          //elqQ.push(['elqDataLookup', escape(emailGroupLookupKey),'<'+primaryUniqueField+'>'+GetElqContentPersonalizationValue('V_ElqEmailAddress')+'</'+primaryUniqueField+'>']); 
        }
        else{
          console.log('Cannot find the contact');
        }
      }

      if(getSubscriptionInfo && (!firstLookup || secondLookup){
        console.log('Enter getSubscriptionInfo');
        if(this.GetElqGroupMembershipStatus){
          loadSubscriptions();
        }
      }
      console.log('Exit SetElqContent');
    }

    // Fire Data Lookup A, Contact Data lookup
    _elqQ.push(['elqDataLookup', escape(contactLookupKey),'<'+primaryUniqueField+'>'+emailAddress+'</'+primaryUniqueField+'>']);

    // Fire Data Lookup C, Email Group Data Lookup
    //_elqQ.push(['elqDataLookup', escape(emailGroupLookupKey),'<'+primaryUniqueField+'>'+emailAddress+'</'+primaryUniqueField+'>']);    

  </script>


  <!-- Script needed for form submission -->
  <script type='text/javascript'><!--//
  var timerId = null, timeout = 5;
  //--></script>
  <script type='text/javascript'><!--//
  function WaitUntilCustomerGUIDIsRetrieved() {
  if (!!(timerId)) {
      if (timeout == 0) {
  return;
  }
  if (typeof this.GetElqCustomerGUID === 'function') {
          document.forms["BasicForm"].elements["elqCustomerGUID"].value = GetElqCustomerGUID();
  return;
  }
  timeout -= 1;
  }
  timerId = setTimeout("WaitUntilCustomerGUIDIsRetrieved()", 500);
  return;
  }
  window.onload = WaitUntilCustomerGUIDIsRetrieved;
  _elqQ.push(['elqGetCustomerGUID']);
  //--></script>
  </body>
</html>